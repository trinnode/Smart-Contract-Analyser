<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    
    <!-- You can change the page title here -->
    <title>Smart Contract Analyzer</title>
    
    <!-- Using Tailwind CSS for a modern look. No setup needed. -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Using the Inter font for clean typography -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    
    <style>
        /* A few custom styles to complement Tailwind */
        body {
            font-family: 'Inter', sans-serif;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }
        /* Simple spinner animation */
        .spinner {
            border-color: transparent;
            border-top-color: #4f46e5;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        /* Custom styling for the select dropdown */
        select {
            -webkit-appearance: none;
            -moz-appearance: none;
            appearance: none;
            background-image: url('data:image/svg+xml;charset=UTF-8,<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="%239ca3af" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="6 9 12 15 18 9"></polyline></svg>');
            background-repeat: no-repeat;
            background-position: right 0.75rem center;
            background-size: 1em;
            padding-right: 2.5rem; /* Make space for the arrow */
        }
        
        /* Gradient background animation */
        .bg-animated {
            background: linear-gradient(-45deg, #1a1a2e, #16213e, #0f172a, #1e293b);
            background-size: 400% 400%;
            animation: gradientShift 15s ease infinite;
        }
        
        @keyframes gradientShift {
            0% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
            100% { background-position: 0% 50%; }
        }
        
        /* Floating animation for icons */
        .float {
            animation: float 3s ease-in-out infinite;
        }
        
        @keyframes float {
            0%, 100% { transform: translateY(0px); }
            50% { transform: translateY(-10px); }
        }
        
        /* Pulse effect for results */
        .pulse-result {
            animation: pulseResult 0.5s ease-in-out;
        }
        
        @keyframes pulseResult {
            0% { transform: scale(0.95); opacity: 0; }
            100% { transform: scale(1); opacity: 1; }
        }
    </style>
</head>
<body class="bg-animated text-gray-200 flex items-center justify-center min-h-screen">

    <div class="w-full max-w-2xl mx-auto p-4 sm:p-6 md:p-8">
        <div class="bg-gray-800/40 backdrop-blur-xl border border-gray-700/30 rounded-3xl shadow-2xl shadow-black/30 overflow-hidden">
            <div class="p-6 md:p-8">
                <!-- App Header -->
                <div class="text-center mb-6">
                    <div class="float mb-4">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-16 w-16 mx-auto text-indigo-400" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="1.5">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M9 12l2 2 4-4m5.618-4.016A11.955 11.955 0 0112 2.944a11.955 11.955 0 01-8.618 3.04A12.02 12.02 0 003 9c0 5.591 3.824 10.29 9 11.622 5.176-1.332 9-6.03 9-11.622 0-1.042-.133-2.052-.382-3.016z" />
                        </svg>
                    </div>
                    <h1 class="text-4xl font-bold text-white bg-gradient-to-r from-indigo-400 to-purple-400 bg-clip-text text-transparent">Smart Contract Analyzer</h1>
                    <p class="text-gray-400 mt-2">Enter a contract address to detect its implemented ERC/EIP standards.</p>
                </div>

                <!-- Input Form -->
                <div class="space-y-4">
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-3">
                        <div class="md:col-span-2">
                             <input type="text" id="contractAddress" placeholder="Enter Contract Address (e.g., 0x...)" class="w-full bg-gray-900/60 border border-gray-600/50 rounded-xl px-4 py-3 text-white placeholder-gray-500 focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 outline-none transition duration-300 backdrop-blur-sm">
                        </div>
                        <div>
                             <select id="networkSelector" class="w-full h-full bg-gray-900/60 border border-gray-600/50 rounded-xl px-4 py-3 text-white focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 outline-none transition duration-300 backdrop-blur-sm">
                                <!-- Network options will be populated by JS -->
                             </select>
                        </div>
                    </div>
                    <button id="checkButton" class="w-full bg-gradient-to-r from-indigo-600 to-purple-600 text-white font-semibold rounded-xl px-6 py-3 hover:from-indigo-500 hover:to-purple-500 active:from-indigo-700 active:to-purple-700 transition duration-300 disabled:from-gray-600 disabled:to-gray-600 disabled:cursor-not-allowed flex items-center justify-center gap-2 shadow-lg hover:shadow-indigo-500/25">
                        <svg id="button-icon" xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="m21 21-6-6m2-5a7 7 0 1 1-14 0 7 7 0 0 1 14 0z"></path></svg>
                        <span id="button-text">Analyze</span>
                    </button>
                </div>
            </div>
            
            <!-- Results Section -->
            <div id="results" class="bg-gray-900/40 p-6 md:p-8 border-t border-gray-700/30 min-h-[200px] flex items-center justify-center backdrop-blur-sm">
                <!-- Initial State -->
                <div id="initial-state" class="text-center text-gray-500">
                    <div class="float">
                        <svg xmlns="http://www.w3.org/2000/svg" class="mx-auto h-12 w-12" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="1">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M10 21h7a2 2 0 002-2V9.414a1 1 0 00-.293-.707l-5.414-5.414A1 1 0 0012.586 3H7a2 2 0 00-2 2v11m0 5l4.879-4.879m0 0a3 3 0 104.243-4.242 3 3 0 00-4.243 4.242z" />
                        </svg>
                    </div>
                    <p class="mt-2">Results will appear here.</p>
                </div>

                <!-- Loading State -->
                <div id="loading-state" class="hidden text-center text-gray-400">
                    <div class="spinner w-10 h-10 rounded-full border-4 mx-auto"></div>
                    <p class="mt-4 font-medium">Analyzing contract on-chain...</p>
                    <p class="text-sm text-gray-500 mt-1">This may take a few seconds</p>
                </div>

                <!-- Error State -->
                <div id="error-state" class="hidden text-center text-red-400">
                    <svg xmlns="http://www.w3.org/2000/svg" class="mx-auto h-12 w-12" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="1.5">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                    </svg>
                    <p id="error-message" class="mt-2 font-semibold">An error occurred.</p>
                    <p class="text-sm text-gray-500 mt-1">Please try again or check the contract address</p>
                </div>

                <!-- Success State -->
                <div id="success-state" class="hidden w-full">
                    <h3 class="text-lg font-semibold text-white mb-1">Analysis for:</h3>
                    <p id="checked-address" class="text-sm text-indigo-400 font-mono break-all mb-4 bg-gray-800/50 rounded-lg p-2"></p>
                    <div id="results-list" class="space-y-3">
                        <!-- Results will be injected here by JavaScript -->
                    </div>
                    <div class="mt-6 pt-4 border-t border-gray-700/30">
                        <p class="text-xs text-gray-500 text-center">Analysis completed • Standards detected via ERC-165 and bytecode analysis</p>
                    </div>
                </div>
            </div>
        </div>
        <footer class="text-center mt-6 text-sm text-gray-500">
            <!-- You can change the footer name or link here -->
            <p>Built for seamless smart contract analysis • <span class="text-indigo-400">Powered by Ethers.js</span></p>
        </footer>
    </div>

    <!-- Ethers.js library for blockchain interaction -->
    <script src="https://cdn.ethers.io/lib/ethers-5.7.2.umd.min.js"></script>

    <script>
        // =================================================================================
        // CONFIGURATION
        // Updated with more reliable RPC endpoints and better error handling
        // =================================================================================
        const networks = {
            "ethereum": {
                name: "Ethereum",
                rpcUrl: "https://eth.llamarpc.com",
                fallbackRpcUrl: "https://mainnet.infura.io/v3/9aa3d95b3bc440fa88ea12eaa4456161"
            },
            "polygon": {
                name: "Polygon",
                rpcUrl: "https://polygon.llamarpc.com",
                fallbackRpcUrl: "https://polygon-rpc.com/"
            },
            "arbitrum": {
                name: "Arbitrum",
                rpcUrl: "https://arbitrum.llamarpc.com",
                fallbackRpcUrl: "https://arb1.arbitrum.io/rpc"
            },
            "optimism": {
                name: "Optimism",
                rpcUrl: "https://optimism.llamarpc.com",
                fallbackRpcUrl: "https://mainnet.optimism.io"
            },
            "bsc": {
                name: "BNB Chain",
                rpcUrl: "https://bsc-dataseed1.binance.org/",
                fallbackRpcUrl: "https://bsc-dataseed.binance.org/"
            },
            "base": {
                name: "Base",
                rpcUrl: "https://mainnet.base.org",
                fallbackRpcUrl: "https://base.llamarpc.com"
            }
        };

        // =================================================================================
        // ERC/EIP STANDARDS DEFINITIONS - Enhanced with more standards
        // =================================================================================
        const standards = [
            {
                name: 'ERC-20',
                type: 'BYTECODE',
                selectors: ['a9059cbb', '18160ddd', '70a08231', '23b872dd', '095ea7b3', 'dd62ed3e'],
                requiredSelectorPercentage: 80,
                description: 'A standard for fungible tokens (like stablecoins or utility tokens).'
            },
            {
                name: 'ERC-721',
                type: 'ERC165',
                interfaceId: '0x80ac58cd',
                description: 'A standard for non-fungible tokens (NFTs), where each token is unique.'
            },
            {
                name: 'ERC-1155',
                type: 'ERC165',
                interfaceId: '0xd9b67a26',
                description: 'A multi-token standard that can represent both fungible and non-fungible tokens.'
            },
            {
                name: 'ERC-721 Metadata',
                type: 'ERC165',
                interfaceId: '0x5b5e139f',
                description: 'Optional extension for ERC-721 that adds token names, symbols, and URIs.'
            },
            {
                name: 'ERC-721 Enumerable',
                type: 'ERC165',
                interfaceId: '0x780e9d63',
                description: 'Optional extension for ERC-721 that adds enumeration capabilities.'
            },
            {
                name: 'ERC-4906',
                type: 'ERC165',
                interfaceId: '0x49064906',
                description: 'Standard for emitting events when NFT metadata is updated.'
            },
            {
                name: 'ERC-2981',
                type: 'ERC165',
                interfaceId: '0x2a55205a',
                description: 'NFT Royalty Standard for handling royalty payments.'
            },
            {
                name: 'ERC-1967',
                type: 'BYTECODE',
                selectors: ['5c60da1b'], // implementation() selector
                requiredSelectorPercentage: 100,
                description: 'Proxy Storage Slots standard for upgradeable contracts.'
            },
            {
                name: 'ERC-173',
                type: 'ERC165',
                interfaceId: '0x7f5828d0',
                description: 'Contract Ownership Standard.'
            },
            {
                name: 'ERC-165',
                type: 'BYTECODE',
                selectors: ['01ffc9a7'], // supportsInterface selector
                requiredSelectorPercentage: 100,
                description: 'Standard Interface Detection - allows contracts to advertise supported interfaces.'
            }
        ];

        // =================================================================================
        // APPLICATION LOGIC - Enhanced with better error handling and UX
        // =================================================================================
        
        // DOM Elements
        const contractAddressInput = document.getElementById('contractAddress');
        const networkSelector = document.getElementById('networkSelector');
        const checkButton = document.getElementById('checkButton');
        const buttonText = document.getElementById('button-text');
        const buttonIcon = document.getElementById('button-icon');
        
        const initialState = document.getElementById('initial-state');
        const loadingState = document.getElementById('loading-state');
        const errorState = document.getElementById('error-state');
        const errorMessage = document.getElementById('error-message');
        const successState = document.getElementById('success-state');
        const checkedAddressEl = document.getElementById('checked-address');
        const resultsList = document.getElementById('results-list');

        // Initialize the network selector on page load
        document.addEventListener('DOMContentLoaded', () => {
            for (const [key, network] of Object.entries(networks)) {
                const option = document.createElement('option');
                option.value = key; // Store network key instead of RPC URL
                option.textContent = network.name;
                networkSelector.appendChild(option);
            }
        });

        // Event Listeners
        checkButton.addEventListener('click', handleCheck);
        contractAddressInput.addEventListener('keydown', (e) => {
            if (e.key === 'Enter') {
                handleCheck();
            }
        });

        // Enhanced provider creation with fallback
        async function createProvider(networkKey) {
            const network = networks[networkKey];
            if (!network) {
                throw new Error('Invalid network selected');
            }

            try {
                const provider = new ethers.providers.JsonRpcProvider(network.rpcUrl);
                // Test the connection
                await provider.getBlockNumber();
                return provider;
            } catch (error) {
                console.warn(`Primary RPC failed for ${network.name}, trying fallback...`);
                if (network.fallbackRpcUrl) {
                    const fallbackProvider = new ethers.providers.JsonRpcProvider(network.fallbackRpcUrl);
                    await fallbackProvider.getBlockNumber(); // Test fallback
                    return fallbackProvider;
                }
                throw error;
            }
        }

        // Main handler function - Enhanced
        async function handleCheck() {
            const address = contractAddressInput.value.trim();
            const networkKey = networkSelector.value;

            // Input validation
            if (!address) {
                showError('Please enter a contract address.');
                return;
            }

            if (!ethers.utils.isAddress(address)) {
                showError('Invalid Ethereum address format. Please check and try again.');
                return;
            }
            
            if (!networkKey) {
                showError('Please select a network.');
                return;
            }

            setLoading(true);

            try {
                // Initialize provider with fallback support
                const provider = await createProvider(networkKey);
                const networkName = networks[networkKey].name;

                const bytecode = await provider.getCode(address);
                if (bytecode === '0x') {
                    showError(`This address is not a smart contract on ${networkName}.`);
                    return;
                }

                // Enhanced parallel checking with timeout
                const checkPromises = standards.map(standard => {
                    const promise = standard.type === 'ERC165' 
                        ? checkERC165(address, standard, provider)
                        : checkBytecode(bytecode, standard);
                    
                    // Add timeout to prevent hanging
                    return Promise.race([
                        promise,
                        new Promise((_, reject) => 
                            setTimeout(() => reject(new Error('Timeout')), 10000)
                        )
                    ]);
                });

                const results = await Promise.all(checkPromises);
                displayResults(address, results, networkName);

            } catch (err) {
                console.error('Analysis error:', err);
                if (err.message.includes('Timeout')) {
                    showError('Analysis timed out. The network may be slow. Please try again.');
                } else if (err.message.includes('Invalid network')) {
                    showError('Network configuration error. Please try a different network.');
                } else {
                    showError('Could not analyze contract. The network may be busy or the RPC endpoint is down.');
                }
            } finally {
                setLoading(false);
            }
        }
        
        // --- ENHANCED CHECKER FUNCTIONS ---

        async function checkERC165(address, standard, provider) {
            const erc165Abi = ["function supportsInterface(bytes4 interfaceId) external view returns (bool)"];
            const contract = new ethers.Contract(address, erc165Abi, provider);
            try {
                const supports = await contract.supportsInterface(standard.interfaceId);
                return { ...standard, detected: supports };
            } catch (error) {
                // Expected if contract doesn't implement ERC165
                return { ...standard, detected: false };
            }
        }

        async function checkBytecode(bytecode, standard) {
            let matches = 0;
            const cleanBytecode = bytecode.substring(2);
            
            for (const selector of standard.selectors) {
                if (cleanBytecode.includes(selector)) {
                    matches++;
                }
            }
            
            const percentage = (matches / standard.selectors.length) * 100;
            return { 
                ...standard, 
                detected: percentage >= standard.requiredSelectorPercentage,
                matchPercentage: percentage
            };
        }

        // --- ENHANCED UI HELPER FUNCTIONS ---

        function setLoading(isLoading) {
            checkButton.disabled = isLoading;
            contractAddressInput.disabled = isLoading;
            networkSelector.disabled = isLoading;
            
            initialState.classList.add('hidden');
            errorState.classList.add('hidden');
            successState.classList.add('hidden');

            if (isLoading) {
                loadingState.classList.remove('hidden');
                buttonText.textContent = 'Analyzing...';
                buttonIcon.innerHTML = `<path d="M21 12a9 9 0 1 1-6.219-8.56"/>`;
            } else {
                loadingState.classList.add('hidden');
                buttonText.textContent = 'Analyze';
                buttonIcon.innerHTML = `<path d="m21 21-6-6m2-5a7 7 0 1 1-14 0 7 7 0 0 1 14 0z"></path>`;
            }
        }

        function showError(message) {
            initialState.classList.add('hidden');
            loadingState.classList.add('hidden');
            successState.classList.add('hidden');
            errorState.classList.remove('hidden');
            errorMessage.textContent = message;
        }

        function displayResults(address, results, networkName) {
            initialState.classList.add('hidden');
            loadingState.classList.add('hidden');
            errorState.classList.add('hidden');
            successState.classList.remove('hidden');

            checkedAddressEl.textContent = `${address} (${networkName})`;
            resultsList.innerHTML = '';

            const detectedCount = results.filter(r => r.detected).length;
            
            // Add summary
            const summary = document.createElement('div');
            summary.className = 'mb-4 p-3 bg-indigo-500/10 border border-indigo-500/20 rounded-xl';
            summary.innerHTML = `
                <p class="text-sm text-indigo-400 font-medium">
                    ${detectedCount} of ${results.length} standards detected
                </p>
            `;
            resultsList.appendChild(summary);

            // Sort results - detected first
            const sortedResults = results.sort((a, b) => b.detected - a.detected);

            sortedResults.forEach((result, index) => {
                const resultElement = document.createElement('div');
                resultElement.className = `pulse-result p-4 rounded-xl flex items-start gap-4 transition-all duration-300 hover:scale-[1.02] ${
                    result.detected 
                        ? 'bg-gradient-to-r from-green-500/10 to-emerald-500/10 border border-green-500/20 hover:border-green-400/30' 
                        : 'bg-gray-700/20 border border-gray-700/30 hover:border-gray-600/50'
                }`;
                
                // Add animation delay
                resultElement.style.animationDelay = `${index * 0.1}s`;
                
                const icon = result.detected 
                    ? `<svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-green-400 flex-shrink-0" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>` 
                    : `<svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-gray-500 flex-shrink-0" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M10 14l2-2m0 0l2-2m-2 2l-2-2m2 2l2 2m7-2a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>`;

                const statusBadge = result.detected 
                    ? `<span class="px-2 py-1 text-xs font-medium text-green-400 bg-green-400/10 rounded-full">Detected</span>`
                    : `<span class="px-2 py-1 text-xs font-medium text-gray-500 bg-gray-500/10 rounded-full">Not Found</span>`;

                resultElement.innerHTML = `
                    ${icon}
                    <div class="flex-1">
                        <div class="flex items-center justify-between">
                            <h4 class="font-semibold text-white">${result.name}</h4>
                            ${statusBadge}
                        </div>
                        <p class="text-sm text-gray-400 mt-1">${result.description}</p>
                        ${result.type ? `<p class="text-xs text-gray-500 mt-1">Detection: ${result.type}</p>` : ''}
                    </div>
                `;
                resultsList.appendChild(resultElement);
            });
        }
    </script>
</body>
</html>
